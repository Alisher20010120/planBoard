<!DOCTYPE html>
<html lang="uz" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trello.com</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(to bottom right, #4caf50, #03a9f4);
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }

        header {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
        }

        header .logout-btn {
            background-color: #ff5722;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s, background-color 0.3s;
        }

        header .logout-btn:hover {
            background-color: #e64a19;
            transform: scale(1.05);
        }

        .container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            box-sizing: border-box; /* Ensure padding is included in the height */
        }

        .kanban-board {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 20px;
            padding: 20px;
            height: 100%;
            flex: 1;
        }

        .kanban-column {
            flex: 0 0 350px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
            height: 100%;
        }

        .kanban-column:hover {
            transform: scale(1.02);
        }

        .card-header {
            background: linear-gradient(to right, #4caf50, #03a9f4);
            color: white;
            font-weight: bold;
            text-align: center;
            border-radius: 15px 15px 0 0;
            padding: 15px;
            font-size: 1.2rem;
        }

        .card-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .task {
            background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
            border-left: 5px solid #2196f3;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
        }

        .task:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .add-column-btn {
            background-color: #03a9f4;
            color: white;
            font-weight: bold;
            border-radius: 25px;
            padding: 10px 20px;
            transition: transform 0.3s, background-color 0.3s;
        }

        .add-column-btn:hover {
            background-color: #0288d1;
            transform: scale(1.05);
        }

        .avatars img {
            border-radius: 50%;
            margin-left: -5px;
            border: 2px solid white;
        }

        .kanban-column:last-child {
            margin-right: 0;
        }

        .btn-task {
            background-color: #ff5722;
            color: white;
            font-weight: bold;
            border-radius: 25px;
            padding: 10px 20px;
            transition: transform 0.3s, background-color 0.3s;
        }

        .btn-task:hover {
            background-color: #e64a19;
            transform: scale(1.05);
        }

        .kanban-column.over {
            border: 2px dashed #03a9f4;
        }

        .filters {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filters .form-group {
            margin: 0;
        }
    </style>
</head>
<body>
<header>
    <h1>Trello</h1>
    <div style="display: flex; align-items: center; justify-content: center;">
        <img th:src="${logginUser != null ? logginUser.photoUrl : '/default-image.jpg'}"
             alt="User Photo"
             style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
        <form action="/logout" method="post">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </div>
</header>
<div class="container">
    <div class="filters">
        <form action="/cabinet" class="d-flex">
            <input type="text" onchange="this.form.submit()" name="title" th:value="${taskFilter != null ? taskFilter.title : 'No Title'}"
                   class="form-control" placeholder="Search" style="width: 250px;">
            <select class="form-control" onchange="this.form.submit()" name="deadline">
                <option value="">All</option>
                <option th:value="${T(java.time.LocalDate).now()}">Deadline Xafli</option>
                <option th:value="${T(java.time.LocalDate).now().plusDays(1)}">Deadline Yaqin</option>
                <option value="">Deadlinesiz</option>
            </select>
            <div class="form-group" style="display: flex; gap: 10px;">
                <label>
                    <input type="radio" name="userId" onchange="this.form.submit()" value="" th:checked="${taskFilter != null and taskFilter.userId == null}">
                    <img th:src="@{https://cdn1.vectorstock.com/i/1000x1000/91/60/user-profile-3d-icon-avatar-or-person-button-vector-46429160.jpg}"
                         alt="All"
                         style="width: 50px; height: 50px; border-radius: 50%; display: block;">
                </label>
                <span>All</span>
                <div th:each="user : ${users}">
                    <label>
                        <input type="radio" onchange="this.form.submit()" name="userId" th:value="${user.id}"
                               th:checked="${taskFilter != null and taskFilter.userId != null and taskFilter.userId == user.id}">
                        <img th:src="@{${user.photoUrl}}" alt="User Image"
                             style="width: 50px; height: 50px; border-radius: 50%; display: block;">
                        <span th:text="${user.firstName}"></span>
                    </label>
                </div>
            </div>
        </form>
        <form action="/report">
            <button class="btn-task">Criminals</button>
        </form>
        <form action="/developer">
            <button class="btn-task">Developer result</button>
        </form>
    </div>

    <div class="kanban-board">
        <div class="kanban-column" th:each="column : ${columns}" th:attr="data-column-id=${column.id}"
             ondragover="allowDrop(event)" ondrop="drop(event)">
            <div class="card">
                <div class="card-header">
                    <h5 th:text="${column.columnName}">Open</h5>
                </div>
                <div class="card-body">
                    <div class="task" th:each="task : ${tasks}" th:if="${task.column.id == column.id}"
                         th:id="${'task-' + task.id}" draggable="true" ondragstart="drag(event)"
                         ondragend="dragEnd(event)">
                        <div>
                            <img alt="Task Image" class="task-image" th:if="${task.getAttachment() != null}"
                                 th:src="|/file/image/${task.getAttachment().id}|" width="300" height="200">
                        </div>
                        <form action="/inTask">
                            <div th:text="${task.title}" style="font-weight: bold;">Task Title</div>
                            <div class="task-footer">
                               <span class="due-date" th:if="${task.column.isCompleted.equals(false)}">
                                    <button th:classappend="
    ${task.deadline != null and task.deadline.equals(T(java.time.LocalDate).now()) ? 'btn btn-danger' :
    task.deadline != null and task.deadline.equals(T(java.time.LocalDate).now().plusDays(1)) ? 'btn btn-warning' :
    task.deadline != null and task.deadline.isBefore(T(java.time.LocalDate).now()) ? 'btn btn-secondary' :
    'btn btn-success'}"
                                            th:text="${task.deadline}">
</button>

                               </span>
                                <input type="hidden" name="taskId" th:value="${task.id}">
                                <button class="btn btn-sm btn-task">Details</button>
                                <span class="avatars" th:each="user:${task.users}">
                                   <img th:src="@{${user.photoUrl}}" alt="img" width="30" height="30">
                                </span>
                            </div>
                        </form>
                    </div>
                </div>
                <form action="/addTask">
                    <button name="columnId" th:value="${column.id}" class="btn btn-success btn-block">Task qo'shish
                    </button>
                </form>
            </div>
        </div>
        <div class="kanban-column">
            <div class="card">
                <div class="card-header">
                    <form action="/addColumn">
                        <button class="btn btn-primary btn-block add-column-btn">+ Yangi ustun qo'shish</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>


<script>
    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        event.dataTransfer.setData("text", event.target.id);
    }

    function dragEnd(event) {
        console.log("Drag operation ended for task:", event.target.id);
    }

    function drop(event) {
        event.preventDefault();
        const taskId = event.dataTransfer.getData("text");
        const column = event.target.closest('.kanban-column');

        if (!taskId || !column) {
            console.error("Error: Task or column not found!");
            return;
        }

        const columnId = column.dataset.columnId;
        console.log("Dropped task ID:", taskId);
        console.log("Target column ID:", columnId);

        const draggedTask = document.getElementById(taskId);

        if (draggedTask && column) {
            column.querySelector('.card-body').appendChild(draggedTask);
            console.log(`Task ${taskId} moved to column ${columnId}`);
            updateTaskColumn(taskId, columnId);
        }
    }

    function updateTaskColumn(taskId, columnId) {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

        fetch("/update-task-column", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": csrfToken
            },
            body: JSON.stringify({
                taskId: taskId.replace("task-", ""),
                columnId: columnId
            }),
        })
            .then((response) => {
                if (!response.ok) throw new Error("Failed to update task column");
                return response.json();
            })
            .then((data) => {
                console.log("Task updated successfully:", data);
            })
            .catch((error) => {
                console.error("Error updating task column:", error);
            });
    }
</script>
</body>
</html>
